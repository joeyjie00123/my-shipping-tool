<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Silver Mark å‘è´§ç¥å™¨</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f7fe; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        button { width: 100%; background: #3370ff; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        #status { margin-top: 15px; font-size: 13px; color: #4a5568; line-height: 1.6; background: #f0f2f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="card">
        <h3 style="margin:0 0 15px 0;">Silver Mark å‘è´§åŠ©æ‰‹</h3>
        <button id="runBtn" disabled>æ­£åœ¨ç¯å¢ƒåˆå§‹åŒ–...</button>
        <div id="status">â³ æ­£åœ¨å°è¯•åŠ è½½é£ä¹¦æ ¸å¿ƒç»„ä»¶...</div>
    </div>

    <script>
        // è´¦å·é…ç½®
        const CONF = {
            id: '38f5678511a9', secret: 'ab12d80d7e294cc9b75ec12af289a600',
            source: 'CN0824176', proxy: 'https://corsproxy.io/?' 
        };

        // --- æ ¸å¿ƒï¼šå¤šé•œåƒ SDK åŠ è½½é€»è¾‘ï¼Œè§£å†³ ERR_NAME_NOT_RESOLVED ---
        const sdkUrls = [
            "https://lf1-cdn-tos.bytegoofy.com/obj/static/base-extension-sdk/base-extension-sdk.js",
            "https://lf3-static.bytednsdoc.com/obj/eden-cn/ptlz_zlp/ljhwZthlaukjlkulzlp/base-extension-sdk.js",
            "https://sf3-cn.feishucdn.net/obj/static/lark/base-extension-sdk/base-extension-sdk.js"
        ];

        function loadSDK(index) {
            if (index >= sdkUrls.length) {
                document.getElementById('status').innerText = "âŒ æ— æ³•è¿æ¥åˆ°é£ä¹¦æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å…³é—­ä»£ç†ã€‚";
                return;
            }
            const script = document.createElement('script');
            script.src = sdkUrls[index];
            script.onload = () => {
                const checkTimer = setInterval(() => {
                    if (window.bitable) {
                        clearInterval(checkTimer);
                        initUI();
                    }
                }, 500);
            };
            script.onerror = () => loadSDK(index + 1);
            document.head.appendChild(script);
        }
        loadSDK(0);

        function initUI() {
            const btn = document.getElementById('runBtn');
            btn.disabled = false;
            btn.innerText = "ğŸš€ ä¸€é”®ä¸‹å•é€‰ä¸­è¡Œ";
            document.getElementById('status').innerText = "âœ… å·²è¿æ¥åˆ°é£ä¹¦åº”ç”¨ï¼\nè¯·é€‰ä¸­è®¢å•è¡Œåç‚¹å‡»ã€‚";
        }

        document.getElementById('runBtn').onclick = async () => {
            const status = document.getElementById('status');
            status.innerText = "ğŸ” æŠ“å–è®¢å•æ•°æ®...";
            try {
                const selection = await bitable.base.getSelection();
                if (!selection.recordId) throw new Error("è¯·å…ˆç‚¹ä¸€ä¸‹è¡¨æ ¼ï¼Œé€‰ä¸­ä¸€è¡Œï¼");
                const table = await bitable.base.getTableById(selection.tableId);
                const record = await table.getRecordById(selection.recordId);
                const f = record.fields;

                const tRes = await fetch(CONF.proxy + encodeURIComponent('https://openapi.yunexpress.cn/openapi/oauth2/token'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "grantType": "client_credentials", "appId": CONF.id, "appSecret": CONF.secret, "sourceKey": CONF.source })
                });
                const tData = await tRes.json();

                const timestamp = new Date().getTime().toString();
                const body = {
                    "product_code": "THPHR",
                    "customer_order_number": f['Etsyè®¢å•å·'] || ("SN"+timestamp),
                    "receiver": {
                        "country_code": "US", "first_name": f['æ”¶ä»¶äººå§“å'] || f['æ”¶ä»¶äºº'] || "Guest",
                        "address_lines": [f['æ”¶è´§åœ°å€'] || ""], "city": f['åŸå¸‚'] || "",
                        "state_or_province": f['çœ/å·'] || "", "zip_code": f['é‚®ç¼–'] || "", "phone_number": f['ç”µè¯'] || ""
                    }
                };

                const bodyStr = JSON.stringify(body);
                const sign = CryptoJS.HmacSHA256(`body=${bodyStr}&date=${timestamp}&method=POST&uri=/v1/order/package/create`, CONF.secret).toString(CryptoJS.enc.Base64);
                
                status.innerText = "ğŸ“¦ æ­£åœ¨æé€Ÿå‘è´§...";
                const oRes = await fetch(CONF.proxy + encodeURIComponent('https://openapi.yunexpress.cn/v1/order/package/create'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'token': tData.accessToken, 'date': timestamp, 'sign': sign },
                    body: bodyStr
                });
                const oData = await oRes.json();

                if (oData.success) {
                    status.innerText = "ğŸ‰ æˆåŠŸï¼å•å·ï¼š" + oData.result.waybill_number;
                    await table.setRecord(selection.recordId, { fields: { 'è¿å•å·': oData.result.waybill_number } });
                } else {
                    status.innerText = "âš ï¸ ä¸šåŠ¡æŠ¥é”™ï¼š" + oData.msg;
                }
            } catch (e) {
                status.innerText = "âŒ æŠ¥é”™ï¼š" + e.message;
            }
        };
    </script>
</body>
</html>
