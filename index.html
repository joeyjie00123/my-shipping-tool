<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Silver Mark Artisan å‘è´§åŠ©æ‰‹</title>
    <script src="https://sf3-cn.feishucdn.net/obj/static/lark/base-extension-sdk/base-extension-sdk.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f9f9f9; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button { width: 100%; background: #3370ff; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        #status { margin-top: 15px; font-size: 13px; color: #666; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="card">
        <h4>Silver Mark Artisan å‘è´§åŠ©æ‰‹</h4>
        <button id="runBtn">ä¸€é”®å‘è´§é€‰ä¸­è¡Œ</button>
        <div id="status">ğŸ’¡ è¯·ç¡®ä¿æ‚¨å·²åœ¨è¡¨æ ¼ä¸­é€‰ä¸­ä¸€è¡Œã€‚</div>
    </div>

    <script>
        // æ‚¨çš„çœŸå®è´¦å·é…ç½®
        const CONF = {
            id: '38f5678511a9',
            secret: 'ab12d80d7e294cc9b75ec12af289a600',
            source: 'CN0824176',
            proxy: 'https://corsproxy.io/?' 
        };

        const runBtn = document.getElementById('runBtn');
        const status = document.getElementById('status');

        // æ ¸å¿ƒä¿®å¤é€»è¾‘ï¼šç­‰å¾… bitable ç¯å¢ƒå°±ç»ª
        runBtn.onclick = async () => {
            // æ£€æŸ¥ SDK æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof bitable === 'undefined') {
                status.innerText = "âŒ SDK æœªåŠ è½½ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢ã€‚";
                return;
            }

            status.innerText = "â³ æ­£åœ¨è¯»å–è¡¨æ ¼æ•°æ®...";
            try {
                // 1. è·å–é€‰ä¸­è¡Œæ•°æ®
                const selection = await bitable.base.getSelection();
                if (!selection.recordId) {
                    status.innerText = "âš ï¸ è¯·å…ˆåœ¨å·¦ä¾§è¡¨æ ¼é‡Œç‚¹å‡»é€‰ä¸­ä¸€è¡Œè®¢å•ï¼";
                    return;
                }
                const table = await bitable.base.getTableById(selection.tableId);
                const record = await table.getRecordById(selection.recordId);
                const fields = record.fields;

                // 2. è·å– Token
                status.innerText = "ğŸš€ æ­£åœ¨è¿æ¥äº‘é€”æˆæƒ...";
                const tRes = await fetch(CONF.proxy + encodeURIComponent('https://openapi.yunexpress.cn/openapi/oauth2/token'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "grantType": "client_credentials", "appId": CONF.id, "appSecret": CONF.secret, "sourceKey": CONF.source })
                });
                const tData = await tRes.json();
                const token = tData.accessToken;

                // 3. å‡†å¤‡æ•°æ® (å­—æ®µåå¯¹åº” image_d6dae4.png)
                const timestamp = new Date().getTime().toString();
                const orderBody = {
                    "product_code": "THPHR", 
                    "customer_order_number": fields['Etsyè®¢å•å·'] || ("AUTO" + timestamp),
                    "receiver": { 
                        "country_code": "US", 
                        "first_name": fields['æ”¶ä»¶äºº'] || "Guest", 
                        "phone_number": fields['ç”µè¯'] || "12345678" 
                    }
                };

                // 4. åŠ å¯†ç­¾åå¹¶ä¸‹å•
                const bodyStr = JSON.stringify(orderBody);
                const sign = CryptoJS.HmacSHA256(`body=${bodyStr}&date=${timestamp}&method=POST&uri=/v1/order/package/create`, CONF.secret).toString(CryptoJS.enc.Base64);

                status.innerText = "ğŸ“¦ æ­£åœ¨æé€Ÿä¸‹å•...";
                const oRes = await fetch(CONF.proxy + encodeURIComponent('https://openapi.yunexpress.cn/v1/order/package/create'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'token': token, 'date': timestamp, 'sign': sign },
                    body: bodyStr
                });
                const oData = await oRes.json();

                if (oData.success) {
                    status.innerText = "âœ… ä¸‹å•æˆåŠŸï¼\nè¿å•å·ï¼š" + oData.result.waybill_number;
                    // è‡ªåŠ¨å°†å•å·å†™å›è¡¨æ ¼
                    await table.setRecord(selection.recordId, { fields: { 'è¿å•å·': oData.result.waybill_number } });
                } else {
                    status.innerText = "âš ï¸ ä¸‹å•å¤±è´¥ï¼š" + oData.msg;
                }
            } catch (e) {
                status.innerText = "âŒ å‘ç”Ÿé”™è¯¯ï¼š" + e.message;
            }
        };
    </script>
</body>
</html>
